<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF Markup App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: "Haas Grot Text R Web", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
    #toolbar {
      position: sticky;
      top: 0;
      z-index: 999;
      background-color: #f5f5f5;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      background: #f5f5f5;
      flex-wrap: wrap;
    }
    .color-dot-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 5px;
      font-size: 12px;
    }
    .color-dot {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .selected {
      border-color: black;
    }
    #canvas-container {
      position: relative;
      overflow: auto;
      width: 100%;
      height: 80vh;
      border: 1px solid #ccc;
    }
    canvas {
      display: block;
    }
    .mark {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      pointer-events: none;
    }
    .reset-button {
      font-size: 10px;
      margin-top: 2px;
      cursor: pointer;
      color: blue;
      text-decoration: underline;
      border: none;
      background: none;
    }
    .button-1 {
      background-color: #2ea44f;
      border-radius: 8px;
      border-style: none;
      box-sizing: border-box;
      color: #FFFFFF;
      cursor: pointer;
      display: inline-block;
      font-family: "Haas Grot Text R Web", "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 14px;
      font-weight: 500;
      height: 40px;
      line-height: 20px;
      list-style: none;
      margin: 5px;
      outline: none;
      padding: 10px 16px;
      position: relative;
      text-align: center;
      text-decoration: none;
      transition: color 100ms;
      vertical-align: baseline;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }

    .button-1:hover,
    .button-1:focus {
      background-color: #d6d6d6;
    }

    #zoom-level {
      margin-left: 10px;
      font-weight: bold;
    }
  #color-tools {
  display: flex;
  flex-direction: row;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 10px;
}
</style>
</head>
<body>
  <div id="toolbar">
  <div id="color-tools"></div>
  <div id="button-group" style="width: 100%; text-align: center; margin-top: 10px;">
    <input type="file" id="upload" accept="application/pdf" class="button-1">
    <button onclick="savePDF()" class="button-1">Save Marked PDF</button>
    <button onclick="resetMarks()" class="button-1">Reset</button>
    <button onclick="zoomIn()" class="button-1">Zoom In</button>
    <button onclick="zoomOut()" class="button-1">Zoom Out</button>
    <button onclick="fitToScreen()" class="button-1">Fit to Screen</button>
    <button onclick="toggleFullscreen()" class="button-1">Fullscreen</button>
    <button onclick="previousPage()" class="button-1">Previous Page</button>
    <button onclick="nextPage()" class="button-1">Next Page</button>
    <span id="zoom-level">Zoom: 100%</span>
    <span id="page-info" style="margin-left: 10px; font-weight: bold;">Page: 1</span>
  </div>
</div>
<div id="canvas-container">
    <canvas id="pdf-canvas"></canvas>
  </div>

  <script>
    const colors = ['red', 'green', 'blue', 'orange', 'purple', 'cyan', 'magenta', 'yellow', 'black', 'gray'];
    const counts = {};
    const marks = {}; // pageNum => [{x, y, color}]
    let selectedColor = colors[0];
    let pdf = null, currentPage = 1, totalPages = 1, viewport = null, scale = 1;

    const toolbar = document.getElementById('color-tools');
    const container = document.getElementById('canvas-container');
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const zoomDisplay = document.getElementById('zoom-level');
    const pageInfo = document.getElementById('page-info');

    function updateZoomLevel() {
      zoomDisplay.textContent = `Zoom: ${Math.round(scale * 100)}%`;
    }

    function updatePageInfo() {
      pageInfo.textContent = `Page: ${currentPage}`;
    }

    function previousPage() {
      if (currentPage > 1) {
        currentPage--;
        renderPage(currentPage);
      }
    }

    function nextPage() {
      if (currentPage < totalPages) {
        currentPage++;
        renderPage(currentPage);
      }
    }

    colors.forEach(color => {
    const labelInput = document.querySelector(`.color-dot[data-color='${color}']`).nextSibling;
    const label = labelInput && labelInput.value ? labelInput.value : `item ${colors.indexOf(color) + 1}`;
    if (counts[color] > 0) {
      pdfDoc.setTextColor(color);
      pdfDoc.text(`${label} (${color}): ${counts[color]}`, 10, textY);
      textY += 18;
    }
  });
      textY += 18;
    }
  });

  // Add all pages after the summary
  for (let i = 1; i <= totalPages; i++) {
    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale: 1 });
    const canvasTemp = document.createElement('canvas');
    canvasTemp.width = viewport.width;
    canvasTemp.height = viewport.height;
    const ctxTemp = canvasTemp.getContext('2d');
    await page.render({ canvasContext: ctxTemp, viewport }).promise;

    const imgData = canvasTemp.toDataURL('image/jpeg');

    if (i === 1) {
      // Place summary text before drawing the first page
      pdfDoc.addPage([viewport.width, viewport.height]);
      pdfDoc.setPage(1);
      pdfDoc.addImage(imgData, 'JPEG', 0, 0, viewport.width, viewport.height);

      // Overlay summary
      pdfDoc.setFontSize(14);
      let textY = 30;
      pdfDoc.setTextColor(0, 0, 0);
      pdfDoc.text('PDF Markup Summary', 10, textY);
      textY += 20;
      colors.forEach(color => {
        const labelInput = document.querySelector(`.color-dot[data-color='${color}']`).nextSibling;
        const label = labelInput && labelInput.value ? labelInput.value : `item ${colors.indexOf(color) + 1}`;
        if (counts[color] > 0) {
          pdfDoc.setTextColor(color);
          pdfDoc.text(`${label} (${color}): ${counts[color]}`, 10, textY);
          textY += 18;
        }
      });
    } else {
      pdfDoc.addPage([viewport.width, viewport.height]);
      pdfDoc.setPage(i + 1);
      pdfDoc.addImage(imgData, 'JPEG', 0, 0, viewport.width, viewport.height);
    }

    if (marks[i]) {
      marks[i].forEach(mark => {
        pdfDoc.setFillColor(mark.color);
        pdfDoc.circle(mark.x, mark.y, 5, 'F');
      });
    }
  }

  const now = new Date();
  const timestamp = now.toISOString().replace(/[:.]/g, '-');
  const filename = `marked_${timestamp}.pdf`;
  pdfDoc.save(filename);
    }

    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === '+') {
        e.preventDefault();
        zoomIn();
      } else if (e.ctrlKey && e.key === '-') {
        e.preventDefault();
        zoomOut();
      }
    });
  </script>
</body>
</html>
